# Generated Code Contract

**Version**: 1.0.0
**Date**: 2025-01-13

## Overview

This document defines the contract for code generated by the `make:crud` command. All generated files must conform to these specifications to ensure consistency with the project's CRUD pattern and constitutional requirements.

## File Generation Contract

### Complete CRUD Generation

For command: `php artisan make:crud Product name:string price:decimal`

**MUST generate exactly 9 files**:

1. `app/Models/Product.php` (Model)
2. `app/Http/Controllers/ProductController.php` (Controller)
3. `app/Http/Requests/Product/StoreRequest.php` (Store validation)
4. `app/Http/Requests/Product/UpdateRequest.php` (Update validation)
5. `app/Http/Resources/ProductResource.php` (API transformation)
6. `resources/js/pages/products/Index.vue` (List page)
7. `resources/js/pages/products/Create.vue` (Create page)
8. `resources/js/pages/products/Edit.vue` (Edit page)
9. `resources/js/pages/products/components/Form.vue` (Reusable form)

### Backend-Only Generation (`--no-views`)

**MUST generate exactly 5 files** (items 1-5 above, skip items 6-9)

## Model Contract

**Path**: `app/Models/{ResourceName}.php`
**Namespace**: `App\Models`

### Required Elements

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use OwenIt\Auditing\Contracts\Auditable;

class Product extends Model implements Auditable
{
    use SoftDeletes;
    use \OwenIt\Auditing\Auditable;

    /**
     * The table associated with the model.
     *
     * @var string
     */
    protected $table = 'products';

    /**
     * The attributes that are mass assignable.
     *
     * @var array<int, string>
     */
    protected $fillable = [
        'name',
        'price',
    ];

    /**
     * The attributes that should be cast.
     *
     * @var array<string, string>
     */
    protected $casts = [
        'price' => 'decimal:2',
    ];
}
```

### Conditional Elements

- **SoftDeletes**: Include unless `--no-soft-deletes` flag
- **Auditable**: Include unless `--no-auditing` flag
- **Custom table**: Include `protected $table` only if `--table` flag provided
- **Relationships**: Include relationship methods if relationship flags provided

### Quality Requirements

- ✅ Must pass PHPStan Level 5
- ✅ Must pass Laravel Pint (PSR-12)
- ✅ Must have proper PHPDoc blocks
- ✅ Must use proper type hints (PHP 8.4 property types)
- ✅ Must not contain `dd()`, `dump()`, or `ray()`

## Controller Contract

**Path**: `app/Http/Controllers/{ResourceName}Controller.php`
**Namespace**: `App\Http\Controllers`

### Required Elements

```php
<?php

namespace App\Http\Controllers;

use App\Http\Requests\Product\StoreRequest;
use App\Http\Requests\Product\UpdateRequest;
use App\Http\Resources\ProductResource;
use App\Models\Product;
use Illuminate\Http\RedirectResponse;
use Inertia\Inertia;
use Inertia\Response;
use Spatie\QueryBuilder\AllowedFilter;
use Spatie\QueryBuilder\QueryBuilder;

class ProductController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index(): Response
    {
        $products = QueryBuilder::for(Product::class)
            ->allowedFilters([
                AllowedFilter::callback('search', function ($query, $value) {
                    $query->where('name', 'like', "%{$value}%");
                }),
                AllowedFilter::partial('name'),
            ])
            ->allowedSorts(['name', 'created_at'])
            ->defaultSort('-created_at')
            ->paginate(15)
            ->withQueryString();

        return Inertia::render('products/Index', [
            'products' => ProductResource::collection($products),
            'filters' => request()->only(['search']),
        ]);
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create(): Response
    {
        return Inertia::render('products/Create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(StoreRequest $request): RedirectResponse
    {
        Product::create($request->validated());

        return redirect()->route('products.index')
            ->with('success', 'Product created successfully.');
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(Product $product): Response
    {
        return Inertia::render('products/Edit', [
            'product' => new ProductResource($product),
        ]);
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(UpdateRequest $request, Product $product): RedirectResponse
    {
        $product->update($request->validated());

        return redirect()->route('products.index')
            ->with('success', 'Product updated successfully.');
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(Product $product): RedirectResponse
    {
        $product->delete();

        return redirect()->route('products.index')
            ->with('success', 'Product deleted successfully.');
    }
}
```

### Pattern Requirements

- ✅ Use Spatie QueryBuilder in `index()` method
- ✅ Use Form Requests for validation (never validate in controller)
- ✅ Use Inertia for all view responses
- ✅ Use Route Model Binding for resource parameters
- ✅ Use `redirect()->route()` for redirects
- ✅ Include flash messages for user feedback
- ✅ Methods in order: index, create, store, edit, update, destroy
- ✅ Proper PHPDoc blocks with return types

### Conditional Elements

- **Eager loading**: If relationships defined, add `->with(['relationship'])`
- **Soft deletes filter**: If SoftDeletes enabled, no additional filter (automatic)

## Form Request Contract (Store)

**Path**: `app/Http/Requests/{ResourceName}/StoreRequest.php`
**Namespace**: `App\Http\Requests\{ResourceName}`

### Required Elements

```php
<?php

namespace App\Http\Requests\Product;

use Illuminate\Foundation\Http\FormRequest;

class StoreRequest extends FormRequest
{
    /**
     * Determine if the user is authorized to make this request.
     */
    public function authorize(): bool
    {
        return true;
    }

    /**
     * Get the validation rules that apply to the request.
     *
     * @return array<string, \Illuminate\Contracts\Validation\ValidationRule|array<mixed>|string>
     */
    public function rules(): array
    {
        return [
            'name' => 'required|string|max:255',
            'price' => 'required|numeric',
        ];
    }
}
```

### Validation Rule Mapping

| Field Type | Default Rule | With :nullable | With :unique |
|-----------|-------------|----------------|--------------|
| string | `required\|string\|max:255` | `nullable\|string\|max:255` | `required\|string\|max:255\|unique:products,name` |
| text | `required\|string` | `nullable\|string` | `required\|string\|unique:products,field` |
| integer | `required\|integer` | `nullable\|integer` | `required\|integer\|unique:products,field` |
| decimal | `required\|numeric` | `nullable\|numeric` | `required\|numeric\|unique:products,field` |
| boolean | `required\|boolean` | `nullable\|boolean` | N/A (unique not applicable) |
| date | `required\|date` | `nullable\|date` | `required\|date\|unique:products,field` |
| datetime | `required\|date` | `nullable\|date` | `required\|date\|unique:products,field` |
| timestamp | `required\|date` | `nullable\|date` | `required\|date\|unique:products,field` |
| json | `required\|json` | `nullable\|json` | N/A (unique not applicable) |

## Form Request Contract (Update)

**Path**: `app/Http/Requests/{ResourceName}/UpdateRequest.php`

### Difference from StoreRequest

**Unique rules MUST ignore current record**:

```php
public function rules(): array
{
    return [
        'name' => 'required|string|max:255',
        'email' => [
            'required',
            'string',
            'email',
            'max:255',
            Rule::unique('products', 'email')->ignore($this->product),
        ],
        'price' => 'required|numeric',
    ];
}
```

## API Resource Contract

**Path**: `app/Http/Resources/{ResourceName}Resource.php`
**Namespace**: `App\Http\Resources`

### Required Elements

```php
<?php

namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class ProductResource extends JsonResource
{
    /**
     * Transform the resource into an array.
     *
     * @return array<string, mixed>
     */
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'name' => $this->name,
            'price' => $this->price,
            'created_at' => $this->created_at->toISOString(),
            'updated_at' => $this->updated_at->toISOString(),
        ];
    }
}
```

### Pattern Requirements

- ✅ Include all fields from field definitions
- ✅ Include `id`, `created_at`, `updated_at` always
- ✅ Timestamps use `toISOString()` for consistent format
- ✅ Return type annotation `array<string, mixed>`

## Vue Index Page Contract

**Path**: `resources/js/pages/{resource-plural}/Index.vue`

### Required Elements

```vue
<script setup lang="ts">
import { router } from '@inertiajs/vue3';
import { Button } from '@/components/ui/button';
import { DataTable } from '@/components/ui/data-table';
import { AlertDialog } from '@/components/ui/alert-dialog';

interface ProductResource {
  id: number;
  name: string;
  price: number;
  created_at: string;
  updated_at: string;
}

interface PaginatedResponse<T> {
  data: T[];
  meta: {
    current_page: number;
    last_page: number;
    per_page: number;
    total: number;
  };
  links: {
    first: string;
    last: string;
    prev: string | null;
    next: string | null;
  };
}

interface Props {
  products: PaginatedResponse<ProductResource>;
  filters: Record<string, string>;
}

const props = defineProps<Props>();

const deleteProduct = (id: number) => {
  if (confirm('Are you sure you want to delete this product?')) {
    router.delete(route('products.destroy', id), {
      preserveScroll: true,
    });
  }
};
</script>

<template>
  <div>
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Products</h1>
      <Button @click="router.visit(route('products.create'))">
        Create Product
      </Button>
    </div>

    <DataTable
      :data="products.data"
      :meta="products.meta"
      :filters="filters"
    />
  </div>
</template>
```

### Pattern Requirements

- ✅ TypeScript strict mode with proper interfaces
- ✅ Shadcn-vue components (Button, DataTable, AlertDialog)
- ✅ Inertia.js router for navigation
- ✅ Proper type definitions for props
- ✅ Delete confirmation dialog
- ✅ Preserve scroll on delete

## Vue Create/Edit Page Contract

**Path**: `resources/js/pages/{resource-plural}/{Create|Edit}.vue`

### Required Elements

```vue
<script setup lang="ts">
import { useForm } from '@inertiajs/vue3';
import Form from './components/Form.vue';

interface Props {
  product?: ProductResource; // Only for Edit page
}

const props = defineProps<Props>();

const form = useForm({
  name: props.product?.name ?? '',
  price: props.product?.price ?? 0,
});

const submit = () => {
  if (props.product) {
    form.put(route('products.update', props.product.id));
  } else {
    form.post(route('products.store'));
  }
};
</script>

<template>
  <div>
    <h1 class="text-2xl font-bold mb-6">
      {{ product ? 'Edit Product' : 'Create Product' }}
    </h1>

    <Form :form="form" @submit="submit" />
  </div>
</template>
```

## Vue Form Component Contract

**Path**: `resources/js/pages/{resource-plural}/components/Form.vue`

### Required Elements

```vue
<script setup lang="ts">
import { InertiaForm } from '@inertiajs/vue3';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';

interface Props {
  form: InertiaForm<{
    name: string;
    price: number;
  }>;
}

defineProps<Props>();

const emit = defineEmits<{
  submit: [];
}>();
</script>

<template>
  <form @submit.prevent="emit('submit')" class="space-y-6">
    <div>
      <Label for="name">Name</Label>
      <Input
        id="name"
        v-model="form.name"
        type="text"
        :error="form.errors.name"
      />
      <span v-if="form.errors.name" class="text-sm text-red-600">
        {{ form.errors.name }}
      </span>
    </div>

    <div>
      <Label for="price">Price</Label>
      <Input
        id="price"
        v-model="form.price"
        type="number"
        step="0.01"
        :error="form.errors.price"
      />
      <span v-if="form.errors.price" class="text-sm text-red-600">
        {{ form.errors.price }}
      </span>
    </div>

    <div class="flex gap-4">
      <Button type="submit" :disabled="form.processing">
        {{ form.processing ? 'Saving...' : 'Save' }}
      </Button>
      <Button
        type="button"
        variant="outline"
        @click="router.visit(route('products.index'))"
      >
        Cancel
      </Button>
    </div>
  </form>
</template>
```

### Pattern Requirements

- ✅ Reusable form component
- ✅ TypeScript props interface
- ✅ Inertia form binding
- ✅ Shadcn-vue Input, Button, Label components
- ✅ Error display for each field
- ✅ Submit button disabled state
- ✅ Cancel button navigation

## Quality Gates

All generated code MUST pass:

1. **PHPStan Level 5**: No type errors in PHP files
2. **Laravel Pint**: PSR-12 code style compliance
3. **TypeScript Compilation**: Zero TypeScript errors in Vue files
4. **Architectural Tests**: No `dd()`, `dump()`, `ray()` functions
5. **Syntax Validation**: Valid PHP/Vue syntax (parseable)

## Naming Conventions

| Element | Convention | Example |
|---------|-----------|---------|
| Resource Name | PascalCase | Product, UserProfile |
| Model Class | PascalCase | Product, UserProfile |
| Table Name | snake_case plural | products, user_profiles |
| Controller Class | PascalCase + "Controller" | ProductController |
| Route Name | kebab-case plural | products, user-profiles |
| Vue Pages Directory | kebab-case plural | products/, user-profiles/ |
| Form Request | PascalCase + "Request" | StoreRequest, UpdateRequest |
| API Resource | PascalCase + "Resource" | ProductResource |

## File Size Expectations

| File Type | Expected Size | Max Size |
|-----------|--------------|----------|
| Model | 500-1,500 bytes | 3,000 bytes |
| Controller | 2,000-4,000 bytes | 8,000 bytes |
| Form Request | 500-1,000 bytes | 2,000 bytes |
| API Resource | 500-1,000 bytes | 2,000 bytes |
| Vue Index | 2,000-4,000 bytes | 8,000 bytes |
| Vue Create/Edit | 1,000-2,000 bytes | 4,000 bytes |
| Vue Form | 2,000-5,000 bytes | 10,000 bytes |

## Backward Compatibility

Generated code structure is versioned independently:

- **Contract Version 1.0.0**: Initial structure
- **Future versions**: New optional elements may be added
- **Breaking changes**: Will increment contract major version
